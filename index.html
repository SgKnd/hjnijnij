<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∏—à–∫–æ–±–ª—É–¥ 4.1 (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; padding-bottom: 80px; }
        
        .view-section { display: none; animation: fadeIn 0.3s ease-in-out; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .tab-button.active { color: #ea580c; border-bottom: 2px solid #ea580c; }
        
        .recipe-card {
            background: white; border-radius: 16px; overflow: hidden;
            margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        .recipe-image { height: 160px; width: 100%; object-fit: cover; }
        .recipe-content { padding: 16px; }

        .autocomplete-items {
            position: absolute; border: 1px solid #d4d4d4; border-bottom: none; border-top: none;
            z-index: 99; top: 100%; left: 0; right: 0; background-color: white;
            border-radius: 0 0 8px 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .autocomplete-items div { padding: 10px; cursor: pointer; background-color: #fff; border-bottom: 1px solid #d4d4d4; }
        .autocomplete-items div:hover { background-color: #e9e9e9; }

        .filter-chip {
            padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 500;
            background-color: #ffffff; border: 1px solid #e5e7eb; color: #374151; cursor: pointer; transition: all 0.2s;
            white-space: nowrap;
        }
        .filter-chip.active { background-color: #ea580c; color: white; border-color: #ea580c; }
        
        .status-chip { display: inline-block; padding: 4px 10px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-bottom: 8px; }
        .status-full { background-color: #dcfce7; color: #166534; }
        .status-partial { background-color: #fef9c3; color: #854d0e; }
        
        .cart-checkbox { width: 20px; height: 20px; accent-color: #ea580c; cursor: pointer; }
        .line-through-gray { text-decoration: line-through; color: #9ca3af; }
        
        /* –°–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>

    <div class="max-w-md mx-auto min-h-screen bg-white shadow-xl overflow-hidden relative pb-16">
        
        <header class="bg-gradient-to-r from-orange-600 to-orange-500 text-white p-4 shadow-md sticky top-0 z-20 flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center gap-2">ü•ò –ö–∏—à–∫–æ–±–ª—É–¥ 4.1</h1>
            <button onclick="window.switchView('cart')" class="relative p-2">
                <span class="text-2xl">üõí</span>
                <span id="cart-badge" class="absolute top-0 right-0 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full hidden">0</span>
            </button>
        </header>

        <!-- –ù–ê–í–ò–ì–ê–¶–ò–Ø (–ò–°–ü–†–ê–í–õ–ï–ù–ê) -->
        <nav class="flex border-b border-gray-200 bg-white sticky top-[60px] z-10 shadow-sm overflow-x-auto no-scrollbar">
            <button class="tab-button flex-1 py-3 px-4 text-sm font-medium text-gray-500 hover:text-gray-700 active whitespace-nowrap" onclick="window.switchView('dashboard')">–ì–ª–∞–≤–Ω–∞—è</button>
            <button class="tab-button flex-1 py-3 px-4 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap" onclick="window.switchView('recipes')">–†–µ—Ü–µ–ø—Ç—ã</button>
            <button class="tab-button flex-1 py-3 px-4 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap" onclick="window.switchView('fridge')">–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫</button>
            <button class="tab-button flex-1 py-3 px-4 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap" onclick="window.switchView('cart')">–ö–æ—Ä–∑–∏–Ω–∞</button>
        </nav>

        <!-- DASHBOARD -->
        <div id="view-dashboard" class="view-section active p-4">
            <div class="mb-6">
                <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center">üî• –°—Ä–æ—á–Ω–æ —Å—ä–µ—Å—Ç—å</h2>
                <div id="expire-block"></div>
            </div>
            <div>
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-lg font-bold text-gray-800">–ß—Ç–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å?</h2>
                    <button onclick="window.renderSuggestions()" class="text-xs font-semibold text-orange-600 bg-orange-50 px-2 py-1 rounded">–û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
                <ul id="suggested-list" class="space-y-4"></ul>
            </div>
        </div>

        <!-- RECIPES -->
        <div id="view-recipes" class="view-section p-4 bg-gray-50 min-h-screen">
            <div class="flex gap-2 mb-4 overflow-x-auto pb-2 no-scrollbar" id="recipe-filters">
                <button class="filter-chip active" onclick="window.filterRecipes('all', this)">–í—Å–µ</button>
                <button class="filter-chip" onclick="window.filterRecipes('breakfast', this)">–ó–∞–≤—Ç—Ä–∞–∫</button>
                <button class="filter-chip" onclick="window.filterRecipes('lunch', this)">–û–±–µ–¥</button>
                <button class="filter-chip" onclick="window.filterRecipes('dinner', this)">–£–∂–∏–Ω</button>
                <button class="filter-chip" onclick="window.filterRecipes('snack', this)">–ó–∞–∫—É—Å–∫–∏</button>
            </div>
            <ul id="recipes-list"></ul>
        </div>

        <!-- FRIDGE -->
        <div id="view-fridge" class="view-section p-4">
            <div class="bg-white p-4 rounded-xl border border-orange-100 shadow-sm mb-6 relative">
                <h3 class="font-semibold text-gray-800 mb-3">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</h3>
                <form id="fridge-form" class="space-y-3" autocomplete="off">
                    <div class="relative">
                        <input type="text" id="fridge-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. '–°—ã—Ä')" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-sm">
                        <div id="autocomplete-list" class="autocomplete-items"></div>
                    </div>
                    <div class="flex gap-2">
                        <input type="number" id="fridge-amount" placeholder="–ö–æ–ª-–≤–æ" step="0.1"
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-sm">
                        <select id="fridge-unit" class="w-24 px-2 py-2 border border-gray-300 rounded-lg bg-white text-sm">
                            <option value="g">–≥</option>
                            <option value="ml">–º–ª</option>
                            <option value="pcs">—à—Ç</option>
                        </select>
                    </div>
                    <div>
                        <input type="date" id="fridge-expire" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-sm text-gray-600">
                    </div>
                    <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 rounded-lg transition">–î–æ–±–∞–≤–∏—Ç—å</button>
                </form>
            </div>
            <div id="fridge-categories-container" class="space-y-4"></div>
        </div>

        <!-- CART -->
        <div id="view-cart" class="view-section p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-gray-800">–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</h2>
                <button onclick="window.clearCompletedCart()" class="text-xs text-red-500 hover:text-red-700">–£–¥–∞–ª–∏—Ç—å –∫—É–ø–ª–µ–Ω–Ω–æ–µ</button>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden min-h-[200px]">
                <ul id="cart-list" class="divide-y divide-gray-100"></ul>
            </div>
        </div>
    </div>

    <script>
      // 1. –î–ê–ù–ù–´–ï
      const recipes = [
        {
          id: "oatmeal", title: "–û–≤—Å—è–Ω–∫–∞ —Å —è–≥–æ–¥–∞–º–∏", type: "breakfast",
          img: "https://images.unsplash.com/photo-1517673132405-a56a62b18caf?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80",
          basePortions: 1, timeMinutes: 10,
          ingredients: [{name:"–û–≤—Å—è–Ω—ã–µ —Ö–ª–æ–ø—å—è",amount:50,unit:"g"}, {name:"–ú–æ–ª–æ–∫–æ",amount:150,unit:"ml"}, {name:"–°–∞—Ö–∞—Ä",amount:10,unit:"g"}, {name:"–Ø–≥–æ–¥—ã",amount:30,unit:"g"}],
          steps: ["–°–≤–∞—Ä–∏ —Ö–ª–æ–ø—å—è –Ω–∞ –º–æ–ª–æ–∫–µ.", "–î–æ–±–∞–≤—å —Å–∞—Ö–∞—Ä –∏ —É–∫—Ä–∞—Å—å —è–≥–æ–¥–∞–º–∏."]
        },
        {
          id: "borsch", title: "–ë–æ—Ä—â –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π", type: "lunch",
          img: "https://images.unsplash.com/photo-1596229415849-c702c2864606?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80",
          basePortions: 4, timeMinutes: 90,
          ingredients: [{name:"–ì–æ–≤—è–¥–∏–Ω–∞",amount:500,unit:"g"},{name:"–°–≤–µ–∫–ª–∞",amount:300,unit:"g"},{name:"–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å",amount:300,unit:"g"},{name:"–ö–∞–ø—É—Å—Ç–∞ –±–µ–ª–æ–∫–æ—á–∞–Ω–Ω–∞—è",amount:300,unit:"g"},{name:"–ú–æ—Ä–∫–æ–≤—å",amount:100,unit:"g"},{name:"–õ—É–∫ —Ä–µ–ø—á–∞—Ç—ã–π",amount:100,unit:"g"},{name:"–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞",amount:50,unit:"g"}],
          steps: ["–°–≤–∞—Ä–∏ –±—É–ª—å–æ–Ω.", "–°–¥–µ–ª–∞–π –∑–∞–∂–∞—Ä–∫—É.", "–í–∞—Ä–∏ –æ–≤–æ—â–∏ –≤ –±—É–ª—å–æ–Ω–µ."]
        },
        {
          id: "stew_potato", title: "–¢—É—à—ë–Ω–∞—è –∫–∞—Ä—Ç–æ—à–∫–∞", type: "dinner",
          img: "https://images.unsplash.com/photo-1534939561126-855b8675edd7?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80",
          basePortions: 2, timeMinutes: 40,
          ingredients: [{name:"–°–≤–∏–Ω–∏–Ω–∞",amount:300,unit:"g"},{name:"–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å",amount:500,unit:"g"},{name:"–õ—É–∫ —Ä–µ–ø—á–∞—Ç—ã–π",amount:80,unit:"g"},{name:"–°–º–µ—Ç–∞–Ω–∞ 20%",amount:80,unit:"g"}],
          steps: ["–û–±–∂–∞—Ä—å –º—è—Å–æ –∏ –ª—É–∫.", "–î–æ–±–∞–≤—å –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å –∏ –≤–æ–¥—É.", "–¢—É—à–∏ –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏."]
        },
        {
          id: "greek_salad", title: "–ì—Ä–µ—á–µ—Å–∫–∏–π —Å–∞–ª–∞—Ç", type: "snack",
          img: "https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80",
          basePortions: 2, timeMinutes: 15,
          ingredients: [{name:"–¢–æ–º–∞—Ç—ã",amount:200,unit:"g"},{name:"–û–≥—É—Ä—Ü—ã",amount:150,unit:"g"},{name:"–°—ã—Ä –§–µ—Ç–∞",amount:100,unit:"g"},{name:"–ú–∞—Å–ª–∏–Ω—ã",amount:50,unit:"g"},{name:"–ú–∞—Å–ª–æ –æ–ª–∏–≤–∫–æ–≤–æ–µ",amount:30,unit:"ml"}],
          steps: ["–ù–∞—Ä–µ–∂—å –∫—É–±–∏–∫–∞–º–∏.", "–ó–∞–ø—Ä–∞–≤—å –º–∞—Å–ª–æ–º."]
        },
        {
          id: "pancakes", title: "–ë–ª–∏–Ω—ã", type: "breakfast",
          img: "https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80",
          basePortions: 3, timeMinutes: 40,
          ingredients: [{name:"–ú–æ–ª–æ–∫–æ",amount:500,unit:"ml"},{name:"–Ø–π—Ü–∞",amount:2,unit:"pcs"},{name:"–ú—É–∫–∞ –ø—à–µ–Ω–∏—á–Ω–∞—è",amount:200,unit:"g"},{name:"–°–∞—Ö–∞—Ä",amount:30,unit:"g"}],
          steps: ["–°–º–µ—à–∞–π —Ç–µ—Å—Ç–æ.", "–ñ–∞—Ä—å –Ω–∞ —Å–∫–æ–≤–æ—Ä–æ–¥–µ."]
        },
        {
          id: "carbonara", title: "–ü–∞—Å—Ç–∞ –ö–∞—Ä–±–æ–Ω–∞—Ä–∞", type: "dinner",
          img: "https://images.unsplash.com/photo-1612874742237-6526221588e3?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80",
          basePortions: 2, timeMinutes: 20,
          ingredients: [{name:"–°–ø–∞–≥–µ—Ç—Ç–∏",amount:200,unit:"g"},{name:"–ë–µ–∫–æ–Ω",amount:100,unit:"g"},{name:"–°—ã—Ä –ü–∞—Ä–º–µ–∑–∞–Ω",amount:50,unit:"g"},{name:"–Ø–π—Ü–∞",amount:2,unit:"pcs"},{name:"–°–ª–∏–≤–∫–∏ 20%",amount:100,unit:"ml"}],
          steps: ["–°–≤–∞—Ä–∏ –ø–∞—Å—Ç—É.", "–û–±–∂–∞—Ä—å –±–µ–∫–æ–Ω.", "–°–º–µ—à–∞–π —Å —Å–æ—É—Å–æ–º."]
        }
      ];

      const INGREDIENT_CATEGORIES = {
          "veg": { label: "üçÖ –û–≤–æ—â–∏ –∏ –§—Ä—É–∫—Ç—ã", items: ["–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å", "–ª—É–∫ —Ä–µ–ø—á–∞—Ç—ã–π", "–º–æ—Ä–∫–æ–≤—å", "–∫–∞–ø—É—Å—Ç–∞ –±–µ–ª–æ–∫–æ—á–∞–Ω–Ω–∞—è", "—Å–≤–µ–∫–ª–∞", "—Ç–æ–º–∞—Ç—ã", "–æ–≥—É—Ä—Ü—ã", "–ø–µ—Ä–µ—Ü –±–æ–ª–≥–∞—Ä—Å–∫–∏–π", "—è–≥–æ–¥—ã", "—á–µ—Å–Ω–æ–∫", "–∑–µ–ª–µ–Ω—å", "–º–∞—Å–ª–∏–Ω—ã"] },
          "meat": { label: "ü•© –ú—è—Å–æ –∏ –†—ã–±–∞", items: ["—Å–≤–∏–Ω–∏–Ω–∞", "–≥–æ–≤—è–¥–∏–Ω–∞", "–∫—É—Ä–∏–Ω–æ–µ —Ñ–∏–ª–µ", "–±–µ–∫–æ–Ω", "–≤–µ—Ç—á–∏–Ω–∞", "–∫–æ–ª–±–∞—Å–∞"] },
          "dairy": { label: "ü•õ –ú–æ–ª–æ—á–∫–∞ –∏ –Ø–π—Ü–∞", items: ["–º–æ–ª–æ–∫–æ", "—Å–º–µ—Ç–∞–Ω–∞ 20%", "—è–π—Ü–∞", "—Å—ã—Ä —Ñ–µ—Ç–∞", "—Å—ã—Ä –ø–∞—Ä–º–µ–∑–∞–Ω", "—Å–ª–∏–≤–∫–∏ 20%", "–º–∞—Å–ª–æ —Å–ª–∏–≤–æ—á–Ω–æ–µ", "—Å—ã—Ä —Ç–≤–µ—Ä–¥—ã–π"] },
          "grocery": { label: "üçù –ë–∞–∫–∞–ª–µ—è –∏ –ø—Ä–æ—á–µ–µ", items: ["–º–∞–∫–∞—Ä–æ–Ω—ã", "—Å–ø–∞–≥–µ—Ç—Ç–∏", "—Ä–∏—Å –∫—Ä—É–≥–ª—ã–π", "–≥—Ä–µ—á–∫–∞", "–º—É–∫–∞ –ø—à–µ–Ω–∏—á–Ω–∞—è", "—Å–∞—Ö–∞—Ä", "—Å–æ–ª—å", "–º–∞—Å–ª–æ —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–µ", "–º–∞—Å–ª–æ –æ–ª–∏–≤–∫–æ–≤–æ–µ", "—Ç–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞", "–æ–≤—Å—è–Ω—ã–µ —Ö–ª–æ–ø—å—è", "—à–∞–º–ø–∏–Ω—å–æ–Ω—ã"] }
      };

      const SYNONYMS = { "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å": ["–∫–∞—Ä—Ç–æ—à–∫–∞"], "–¢–æ–º–∞—Ç—ã": ["–ø–æ–º–∏–¥–æ—Ä"], "–°–ø–∞–≥–µ—Ç—Ç–∏": ["–º–∞–∫–∞—Ä–æ–Ω—ã", "–ø–∞—Å—Ç–∞"], "–õ—É–∫ —Ä–µ–ø—á–∞—Ç—ã–π": ["–ª—É–∫"], "–Ø–π—Ü–∞": ["—è–π—Ü–æ"] };

      // 2. –£–¢–ò–õ–ò–¢–´ –ò –°–û–°–¢–û–Ø–ù–ò–ï
      const STORAGE_KEY_FRIDGE = "kishkoblud_fridge_fixed";
      const STORAGE_KEY_CART = "kishkoblud_cart_fixed";
      
      let fridge = JSON.parse(localStorage.getItem(STORAGE_KEY_FRIDGE) || "[]");
      let cart = JSON.parse(localStorage.getItem(STORAGE_KEY_CART) || "[]");
      let currentFilter = "all";

      function saveFridge() { localStorage.setItem(STORAGE_KEY_FRIDGE, JSON.stringify(fridge)); }
      function saveCart() { localStorage.setItem(STORAGE_KEY_CART, JSON.stringify(cart)); window.updateCartBadge(); }

      const allIngredientsCanon = Array.from(new Set(recipes.flatMap(r => r.ingredients.map(i => i.name)))).sort();
      
      function getCanonicalName(input) {
          const lower = input.trim().toLowerCase();
          const direct = allIngredientsCanon.find(ci => ci.toLowerCase() === lower);
          if (direct) return direct;
          for (const [canon, variants] of Object.entries(SYNONYMS)) {
              if (variants.some(v => v === lower) || canon.toLowerCase() === lower) return canon;
          }
          return input.charAt(0).toUpperCase() + input.slice(1);
      }

      function getCategoryForIngredient(name) {
          const lower = name.toLowerCase();
          for (const [key, data] of Object.entries(INGREDIENT_CATEGORIES)) {
              if (data.items.some(i => i === lower)) return key;
          }
          return "other";
      }

      function formatUnit(unit) { const map = { "g": "–≥", "ml": "–º–ª", "pcs": "—à—Ç", "to_taste": "–ø–æ –≤–∫—É—Å—É" }; return map[unit] || unit; }
      function getDaysDiff(d) { if(!d) return null; return Math.ceil((new Date(d) - new Date().setHours(0,0,0,0)) / (1000 * 60 * 60 * 24)); }

      // 3. –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò (–Ω–∞–≤–µ—à–∏–≤–∞–µ–º –Ω–∞ window)
      
      window.switchView = function(view) {
          const sections = { dashboard: "view-dashboard", recipes: "view-recipes", fridge: "view-fridge", cart: "view-cart" };
          Object.values(sections).forEach(id => document.getElementById(id).classList.remove("active"));
          document.getElementById(sections[view]).classList.add("active");
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (–ø—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É, —Ç.–∫. onclick –∂–µ—Å—Ç–∫–æ –∑–∞–¥–∞–Ω)
          document.querySelectorAll(".tab-button").forEach(btn => {
              if (btn.getAttribute("onclick").includes(view)) btn.classList.add("active");
              else btn.classList.remove("active");
          });

          if(view === 'fridge') window.renderFridge();
          if(view === 'cart') window.renderCart();
          if(view === 'recipes') window.renderRecipes();
          if(view === 'dashboard') { window.renderSuggestions(); window.renderExpireBlock(); }
      };

      window.filterRecipes = function(type, btnElement) {
          currentFilter = type;
          document.querySelectorAll(".filter-chip").forEach(b => b.classList.remove("active"));
          btnElement.classList.add("active");
          window.renderRecipes();
      };

      // –ö–û–†–ó–ò–ù–ê
      window.addToCart = function(ingredients) {
          ingredients.forEach(newMsg => {
             const existing = cart.find(c => c.name === newMsg.name && c.unit === newMsg.unit && !c.checked);
             if (existing) existing.amount += newMsg.amount;
             else cart.push({ name: newMsg.name, amount: newMsg.amount, unit: newMsg.unit, checked: false, id: Date.now() + Math.random() });
          });
          saveCart();
          alert(`–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É!`);
          window.updateCartBadge();
      };

      window.toggleCartItem = function(id) {
          const item = cart.find(c => c.id == id);
          if (item) { item.checked = !item.checked; saveCart(); window.renderCart(); }
      };

      window.clearCompletedCart = function() {
          cart = cart.filter(c => !c.checked);
          saveCart();
          window.renderCart();
      };

      window.renderCart = function() {
          const list = document.getElementById("cart-list");
          list.innerHTML = "";
          if (!cart.length) { list.innerHTML = '<div class="p-8 text-center text-gray-400">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ üõí</div>'; return; }
          cart.forEach(item => {
              const li = document.createElement("li");
              li.className = "flex items-center justify-between p-4 bg-white hover:bg-gray-50 transition";
              const textClass = item.checked ? "line-through-gray" : "text-gray-800";
              const amountDisplay = item.amount ? `${parseFloat(item.amount.toFixed(1))} ${formatUnit(item.unit)}` : "";
              li.innerHTML = `
                  <div class="flex items-center gap-3 flex-1 cursor-pointer" onclick="window.toggleCartItem('${item.id}')">
                      <input type="checkbox" class="cart-checkbox" ${item.checked ? "checked" : ""}>
                      <div class="${textClass} font-medium">${item.name} <span class="text-sm text-gray-500 font-normal ml-1">${amountDisplay}</span></div>
                  </div>
                  <button class="text-gray-300 hover:text-red-500 p-2" onclick="window.deleteCartItem('${item.id}')">‚úï</button>`;
              list.appendChild(li);
          });
          window.updateCartBadge();
      };

      window.deleteCartItem = function(id) { cart = cart.filter(c => c.id != id); saveCart(); window.renderCart(); };
      window.updateCartBadge = function() {
          const badge = document.getElementById("cart-badge");
          const count = cart.filter(c => !c.checked).length;
          badge.textContent = count;
          badge.classList.toggle("hidden", count === 0);
      };

      // –•–û–õ–û–î–ò–õ–¨–ù–ò–ö
      window.renderFridge = function() {
          const container = document.getElementById("fridge-categories-container");
          container.innerHTML = "";
          if (!fridge.length) { container.innerHTML = '<div class="p-6 text-center text-gray-400 italic">–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–¥—É–∫—Ç—ã —Å–≤–µ—Ä—Ö—É.</div>'; return; }
          
          const groups = { "veg": [], "meat": [], "dairy": [], "grocery": [], "other": [] };
          fridge.forEach(item => {
              const catKey = getCategoryForIngredient(item.name);
              if (groups[catKey]) groups[catKey].push(item); else groups["other"].push(item);
          });

          Object.keys(groups).forEach(key => {
              if (groups[key].length === 0) return;
              const label = INGREDIENT_CATEGORIES[key]?.label || "üì¶ –†–∞–∑–Ω–æ–µ";
              const section = document.createElement("div");
              section.innerHTML = `<h4 class="font-bold text-gray-700 mb-2 px-1 sticky top-0 bg-gray-50/90 py-1 backdrop-blur-sm">${label}</h4>`;
              const ul = document.createElement("ul");
              ul.className = "bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm divide-y divide-gray-100";
              
              groups[key].sort((a,b) => (getDaysDiff(a.expiresAt) ?? 999) - (getDaysDiff(b.expiresAt) ?? 999)).forEach(item => {
                  const li = document.createElement("li");
                  li.className = "flex items-center justify-between p-3 hover:bg-orange-50/30 transition";
                  const diff = getDaysDiff(item.expiresAt);
                  let dateBadge = "";
                  if (diff !== null) {
                      if (diff < 0) dateBadge = `<span class="text-[10px] bg-red-100 text-red-700 px-2 py-0.5 rounded-full font-bold">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>`;
                      else if (diff <= 2) dateBadge = `<span class="text-[10px] bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full">–°—Ä–æ–∫!</span>`;
                  }
                  li.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center gap-2"><span class="font-medium text-gray-800">${item.name}</span>${dateBadge}</div>
                        <div class="text-xs text-gray-500">${item.amount} ${formatUnit(item.unit)}</div>
                    </div>
                    <button class="text-gray-300 hover:text-red-500 p-2" onclick="window.deleteFridgeItem('${item.name}')">‚úï</button>`;
                  ul.appendChild(li);
              });
              section.appendChild(ul);
              container.appendChild(section);
          });
      };

      window.deleteFridgeItem = function(name) {
          fridge = fridge.filter(i => i.name !== name); saveFridge(); window.renderFridge();
      };

      document.getElementById("fridge-form").addEventListener("submit", (e) => {
          e.preventDefault();
          const nameInput = document.getElementById("fridge-name");
          const name = getCanonicalName(nameInput.value);
          const amount = parseFloat(document.getElementById("fridge-amount").value);
          const unit = document.getElementById("fridge-unit").value;
          const expiresAt = document.getElementById("fridge-expire").value || null;
          if(!name || isNaN(amount)) return;

          const existing = fridge.find(i => i.name === name && i.unit === unit);
          if (existing) { existing.amount += amount; if (expiresAt) existing.expiresAt = expiresAt; }
          else { fridge.push({name, amount, unit, expiresAt}); }
          
          saveFridge();
          nameInput.value = "";
          document.getElementById("fridge-amount").value = "";
          window.renderFridge();
      });

      // –†–ï–¶–ï–ü–¢–´
      function getRecipeMatchStatus(recipe, portionMultiplier = 1) {
          const missing = [];
          recipe.ingredients.forEach(ing => {
            if (ing.amount === null) return;
            const needed = ing.amount * portionMultiplier;
            const fridgeItem = fridge.find(i => i.name.toLowerCase() === ing.name.toLowerCase());
            if (!fridgeItem) missing.push({ ...ing, amount: needed });
            else if (fridgeItem.amount < needed) missing.push({ ...ing, amount: needed - fridgeItem.amount });
          });
          return { status: missing.length === 0 ? "full" : missing.length === recipe.ingredients.length ? "none" : "partial", missing };
      }

      function createRecipeCard(recipe, matchInfo) {
          const li = document.createElement("li");
          li.className = "recipe-card";
          li.dataset.id = recipe.id;
          li.dataset.base = recipe.basePortions;
          li.dataset.current = recipe.basePortions;

          let statusBadge = "";
          if (matchInfo.status === "full") statusBadge = `<span class="status-chip status-full">–ì–æ—Ç–æ–≤—å!</span>`;
          else if (matchInfo.status === "partial") statusBadge = `<span class="status-chip status-partial">–î–æ–∫—É–ø–∏—Ç—å</span>`;

          const ingredientsHtml = recipe.ingredients.map(ing => {
             const fridgeItem = fridge.find(i => i.name.toLowerCase() === ing.name.toLowerCase());
             const hasEnough = fridgeItem && fridgeItem.amount >= ing.amount;
             const color = !fridgeItem ? "text-red-500" : (!hasEnough ? "text-orange-500" : "text-gray-700");
             return `<div class="flex justify-between ${color}"><span>${ing.name}</span><span class="ing-amount" data-base="${ing.amount}">${ing.amount} ${formatUnit(ing.unit)}</span></div>`;
          }).join('');

          li.innerHTML = `
             <div class="relative"><img src="${recipe.img}" class="recipe-image"><div class="absolute bottom-2 right-2 bg-white/90 px-2 py-1 rounded text-xs font-bold text-gray-700 shadow-sm">‚è± ${recipe.timeMinutes} –º–∏–Ω</div></div>
             <div class="recipe-content">
                <div class="flex justify-between items-start mb-2"><h3 class="font-bold text-gray-800 text-lg leading-tight w-3/4">${recipe.title}</h3></div>
                ${statusBadge}
                <div class="flex items-center justify-between bg-orange-50 rounded-lg p-2 my-3">
                    <span class="text-sm font-semibold text-orange-800">–ü–æ—Ä—Ü–∏–∏:</span>
                    <div class="flex items-center bg-white rounded-md shadow-sm border border-orange-200">
                        <button class="px-3 py-1 text-orange-600 hover:bg-orange-50 font-bold" onclick="window.changePortion('${recipe.id}', -1)">-</button>
                        <span class="px-2 font-bold text-gray-800 w-8 text-center portion-val">${recipe.basePortions}</span>
                        <button class="px-3 py-1 text-orange-600 hover:bg-orange-50 font-bold" onclick="window.changePortion('${recipe.id}', 1)">+</button>
                    </div>
                </div>
                <div class="ing-list mb-4 text-sm text-gray-600 space-y-1">${ingredientsHtml}</div>
                <div class="flex gap-2">
                     <button onclick="window.cookRecipe('${recipe.id}')" class="flex-1 bg-green-100 text-green-700 py-2 rounded text-sm font-semibold hover:bg-green-200">‚úÖ –ì–æ—Ç–æ–≤–æ</button>
                     <button onclick="window.addMissingToCart('${recipe.id}')" class="flex-1 bg-orange-100 text-orange-700 py-2 rounded text-sm font-semibold hover:bg-orange-200">üõí –í –∫–æ—Ä–∑–∏–Ω—É</button>
                </div>
             </div>`;
          return li;
      }

      window.changePortion = function(id, delta) {
          const card = document.querySelector(`li[data-id="${id}"]`);
          let current = parseInt(card.dataset.current) + delta;
          if (current < 1) current = 1;
          card.dataset.current = current;
          card.querySelector(".portion-val").textContent = current;
          const ratio = current / parseInt(card.dataset.base);
          card.querySelectorAll(".ing-amount").forEach(el => {
              const base = parseFloat(el.dataset.base);
              if (base) el.textContent = `${parseFloat((base * ratio).toFixed(1))} ${el.textContent.split(' ')[1]}`;
          });
      };

      window.addMissingToCart = function(id) {
          const card = document.querySelector(`li[data-id="${id}"]`);
          const recipe = recipes.find(r => r.id === id);
          const ratio = parseInt(card.dataset.current) / parseInt(card.dataset.base);
          const { missing } = getRecipeMatchStatus(recipe, ratio);
          if (missing.length === 0) { alert("–£ –≤–∞—Å –∏ —Ç–∞–∫ –≤—Å–µ –µ—Å—Ç—å –¥–ª—è —ç—Ç–æ–≥–æ —Ä–µ—Ü–µ–ø—Ç–∞!"); return; }
          window.addToCart(missing);
      };
      
      window.cookRecipe = function(id) {
          const card = document.querySelector(`li[data-id="${id}"]`);
          const recipe = recipes.find(r => r.id === id);
          const ratio = parseInt(card.dataset.current) / parseInt(card.dataset.base);
          if(!confirm(`–°–ø–∏—Å–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã?`)) return;
          let changed = false;
          recipe.ingredients.forEach(ing => {
              const fridgeItem = fridge.find(i => i.name.toLowerCase() === ing.name.toLowerCase());
              if(fridgeItem && ing.amount) {
                  fridgeItem.amount -= (ing.amount * ratio);
                  if (fridgeItem.amount <= 0) fridge = fridge.filter(f => f !== fridgeItem);
                  changed = true;
              }
          });
          if(changed) { saveFridge(); window.renderFridge(); window.renderRecipes(); alert("–ü—Ä–æ–¥—É–∫—Ç—ã —Å–ø–∏—Å–∞–Ω—ã."); } 
          else { alert("–ù–µ—á–µ–≥–æ —Å–ø–∏—Å—ã–≤–∞—Ç—å."); }
      };

      window.renderRecipes = function() {
          const list = document.getElementById("recipes-list");
          list.innerHTML = "";
          const filtered = currentFilter === "all" ? recipes : recipes.filter(r => r.type === currentFilter);
          filtered.forEach(r => list.appendChild(createRecipeCard(r, getRecipeMatchStatus(r, 1))));
      };

      window.renderSuggestions = function() {
          const list = document.getElementById("suggested-list");
          list.innerHTML = "";
          const suggestions = recipes.map(r => ({ r, match: getRecipeMatchStatus(r) })).filter(x => x.match.status !== "none").sort((a,b) => (a.match.status === "full" ? -1 : 1));
          if(!suggestions.length) list.innerHTML = '<div class="text-center py-8 text-gray-500">–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–¥—É–∫—Ç—ã –≤ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫!</div>';
          suggestions.forEach(item => list.appendChild(createRecipeCard(item.r, item.match)));
      };

      window.renderExpireBlock = function() {
         const block = document.getElementById("expire-block");
         block.innerHTML = "";
         const badItems = fridge.filter(i => getDaysDiff(i.expiresAt) !== null && getDaysDiff(i.expiresAt) <= 2);
         if(!badItems.length) block.innerHTML = '<div class="text-sm text-gray-500 bg-green-50 p-2 rounded">–í—Å–µ —Å–≤–µ–∂–µ–µ!</div>';
         else badItems.forEach(i => block.innerHTML += `<div class="text-sm p-2 bg-red-50 text-red-800 rounded mb-1">‚è∞ ${i.name} –∏—Å—Ç–µ–∫–∞–µ—Ç!</div>`);
      };

      // AUTOCOMPLETE
      (function setupAutocomplete() {
          const inp = document.getElementById("fridge-name");
          inp.addEventListener("input", function(e) {
              let val = this.value;
              let listDiv = document.getElementById("autocomplete-list");
              listDiv.innerHTML = "";
              if (!val) return;
              const suggestions = new Set();
              allIngredientsCanon.forEach(ci => { if(ci.toLowerCase().includes(val.toLowerCase())) suggestions.add(ci); });
              let count = 0;
              for (let sug of suggestions) {
                  if (count > 5) break;
                  const itemDiv = document.createElement("DIV");
                  itemDiv.innerHTML = `<b>${sug.substr(0, val.length)}</b>${sug.substr(val.length)}`;
                  itemDiv.innerHTML += `<input type='hidden' value='${sug}'>`;
                  itemDiv.addEventListener("click", function() {
                      inp.value = this.getElementsByTagName("input")[0].value;
                      listDiv.innerHTML = "";
                  });
                  listDiv.appendChild(itemDiv);
                  count++;
              }
          });
      })();

      // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
      window.updateCartBadge();
      window.switchView("dashboard");
    </script>
</body>
</html>
